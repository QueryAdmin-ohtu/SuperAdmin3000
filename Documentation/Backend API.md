# Backend API

Backend provides Flask API for managing the surveys stored in the PostgreSQL database.

## API endpoints

| URI                       | METHOD | Â DESCRIPTION                                                                                                                                                                                                                                                                                                                                                          |
| ------------------------- | ------ | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| /                         | GET    | **If not authenticated** displays google login page. **If authenticated** show existing surveys. Variables passed to the template: `surveys (list)` contains `survey id (int), title (str), question count (int), submission count (int), survey status (list)`.<br /><br />The list `survey status` contains `status (str)`, `no_survey_results (bool)`, `no_categories (bool)`, `unrelated_categories_in_weights (list of str)`, `no_questions (bool)`, `questions_without_answers (list of str)`, `questions_without_categories (list of str)`, `categories_without_questions (list of str)`, `categories_without_results (dict [question id: category name])`.   |
| /google_login             | POST   | Authenticates Google SSO login and checks if the `email (str)` received from the rendered template has access to the service. |
| /logout                   | POST   | Terminates the current session and logs the user out of the system. |
| /admins                   | GET    | Fetches the current authorized users. Variables passed to the to the template: `admins (list)` containing tuples with the `id (str), email (str)`. |
| /admins/new               | POST   | Adds the given `email (str)` received from the rendered template to the database table of authorized users |
| /logs                     | GET    | Show event logs. Variables passed to the template: `event_logs (list)` containing `username (str), filename (str), log_requests (str), sensitive (str)`. |
| /logs/oldestfirst         | GET    | Same view as `/logs` with the events reversed by entry time. |
| /surveys/new-survey       | GET    | Display the page for creating a new survey. |
| /surveys/new-survey       | POST   | Insert new survey to the database. Variables received from the rendered template: `name (str)`, `title (str)`, `survey (str)`. |
| /surveys/<survey_id>/edit | GET    | Display the given survey. Variables passed to the template: `survey (list)` containing `id (int), name (str), createdAt (timestamptz), updatedAt (timestamptz), title_text (str), survey_text (str)`. |
| /surveys/<survey_id>/edit | POST   | Update the given survey to the database. Variables received from the template: `survey_id (int)`, `name (str)`, `title (str)`, `description (str)`. |
| /surveys/<survey_id>/delete-survey | POST   | Delete the given survey. Variables received from the template: `survey_id (int)`, `confirmation_text (str)`. |
| /surveys/<survey_id>      | GET    | View the details for the given survey. Variables passed to the template: `survey_id (int)`.<br /><br />Show `survey (list)` containing `id (int), name (str), createdAt (timetz), updatedAt (timetz), title_text (str), survey_text (str)`,<br /><br /> `questions (list)` containing `id (int), text (str), surveyId (int), category_weights (json), createdAt (timestamptz), updatedAt (timestamptz)`,<br /><br />`categories (list)` containing `id (int), name (str), description (str), content_links (json)`,<br /><br />`results (list)` containing `id (int), text (str), cutoff_from_maxpoints (float)`,<br /><br />`show_results (list of str)`,<br /><br />`survey_status (list)` containing `status (str)`, `no_survey_results (bool)`, `no_categories (bool)`, `unrelated_categories_in_weights (list of str)`, `no_questions (bool)`, `questions_without_answers (list of str)`, `questions_without_categories (list of str)`, `categories_without_questions (list of str)`, `categories_without_results (dict [question id: category name])`. |
| /surveys/<survey_id>/new-question | GET    | Display the page for creating a new question.<br /><br />Variables passed to the template: `categories (list)` containing `id (int), name (str), description (str), content_links (json)`.<br /><br />Passed variables:<br /><br />`survey (list)` containing `id (int), name (str), createdAt (timetz), updatedAt (timetz), title_text (str), survey_text (str)`,<br /><br />`weights (dict)`.|
| /surveys/<survey_id>/new-question | POST   | Insert a new question to the database if `request.form["edit"]` is not true. Requires user input `text (str)`, `survey_id (int)`. Takes multiple `weight (str)` as optional input.<br /><br /> If `request.form["edit"]` is true receive `original_answers (list)` and each `answer (str)`, `points (str)` and update them to the database. Also take optional user input `answer_text (str)`, `point (str)` and create a new answer to the question if given. |
| /surveys/<survey_id>/questions/<question_id> | GET    | Display the page for editing a question. Pass variables `text (str)`, `weights (dict)`, `created (timestamptz)`, `edit (bool)`, `question_id (int)`, `show_next_button (bool)`, `show_previous_button (bool)`,<br /><br />`survey (list)` containing `id (int), name (str), createdAt (timestamptz), updatedAt (timestamptz), title_text (str), survey_text (str)`,<br /><br /> `categories (list)` containing `id (int), name (str), description (str), content_links (json)`,<br /><br /> `answers (list)` with each item containing `id (int), text (str), points (float)`. |
| /surveys/<survey_id>/questions/<question_id>/next | GET    | Display the page for editing the next question relative to the rendered page. |
| /surveys/<survey_id>/questions/<question_id>/previous | GET    | Display the page for editing the previous question relative to the rendered. |
| /surveys/<survey_id>/question/<question_id>/answers/<answer_id> | POST   | Delete the answer from the database. |
| /surveys/delete/<survey_id>/<question_id> | POST   | Delete the question from database. |
| /edit_category/<survey_id>/<category_id> | GET    | Display the page for creating or editing a category. Passed variables when creating a new category include `survey_id (int)`, `survey (list)` containing `id (int), name (str), createdAt (timestamptz), updatedAt (timestamptz), title_text (str), survey_text (str)`.<br /><br /><br />When editing an existing category passed variables include `survey_id (int)`, `name (str)`, `edit (bool)`, `category_id (int)`,<br /><br />`survey_id (int)`, `survey (list)` containing `id (int), name (str), createdAt (timestamptz), updatedAt (timestamptz), title_text (str), survey_text (str)`,<br /><br /> `category_results (list)` containing `id (int), text (str), cutoff_from_maxpoints (float)`,<br /><br />`content_links (json)` with `type` and `url`. |
| /edit_category | POST   | Create or update category information to the database. Variables received from the rendered template when `edit` is false: `survey_id (str)`, `name (str)`, `description (str)`.<br /><br /><br />Variables received from the rendered template when `edit` is true: multiple user input `url (str)`, `type (str)`. |
| /edit_category/<survey_id>/<category_id>/new-category-result | POST   | Insert the new category result to the database. Variables received from the rendered template: `survey_id (int)`, `category_id (int)`, `new_cat_result_text (str)`, `new_cat_cutoff (str)` and user input `result (str)`, `cutoff (str)`. |
| /edit_category/<survey_id>/<category_id>/new-category-result | GET   | Display the page for creating category results. Variables passed to the rendered template: `first (bool)`,<br /><br />`survey (list)` containing `id (int), name (str), createdAt (timestamptz), updatedAt (timestamptz), title_text (str), survey_text (str)`, <br /><br />`category (list)` containing `id (int), name (str), description (str), content_links (json), createdAt (timestamptz), updatedAt (timestamptz), survey_id (int)`,<br /><br />`results (list)` containing `id (int), text (str), cutoff_from_maxpoints (float)`. |
| /add_content_link | POST   | Store updated content links to the database. Variables received from the rendered template: `survey_id (str)`, `category_id (str)`, multiple `type (str) and url (str)` pairs, `new_url (str)`, `new_type (str)`. |
| /delete_category | POST   | Delete the category from the database, updates the category weights in questions and deletes the category results for the category. Variables received from the template: `category_id (str)`, `survey_id (str)`, `cat_name (str)`. |
| /delete_category_result/<category_result_id> | POST   | Delete the category result. Variables received from the rendered template: `survey_id (str)`, `category_id (str)`. |
| /surveys/<survey_id>/new-survey-result | GET   | Display the page for creating survey results. Variables passed to the template: `survey (list)` containing `id (int), name (str), createdAt (timestamptz), updatedAt (timestamptz), title_text (str), survey_text (str)`,<br /><br />`results (list)` containing `id (int), text (str), cutoff_from_maxpoints (int)`,<br /><br />`first (bool)`. |
| /surveys/<survey_id>/new-survey-result | POST   | Handles creating a new survey result and updates any edited survey results. Variables received from the rendered template: `survey_id (str)`, `text (str)`, `cutoff_value (str)`,<br /><br />`original_results (list)` containing `id (int), text (str), cutoff_from_maxpoints (int)`,<br /><br />multiple `result (str) and cutoff (str)` pairs. |
| /delete_survey_result/<result_id> | POST   | Deletes the given survey result. Variables received from the rendered template: `survey_id (int)`. |
| /surveys | GET   | Redirects to home page. |
| /surveys/<survey_id>/statistics | GET   | Display the statistics for the given survey. Variables passed to the template: `survey_id (int)`, `total_users (int)`, `users (list of str)`, `submissions (int)`, `show_userlist (bool)`, `filtered (bool)`, `group_names (list of str)`, `filter_email (str)`, `filter_group_id (str)`, `filter_end_date (str)`, `filter_start_date (str)`,<br /><br />`answer_charts (zip object)` containing all `question_id (int) and question_name (str)`, <br /><br />`categories (list)` containing `category id (int), category name (str), average score (float), average score for unfiltered results (float)`,<br /><br />`survey (list)` containing `id (int), name (str), createdAt (timestamptz), updatedAt (timestamptz), title_text (str), survey_text (str)`.  |
